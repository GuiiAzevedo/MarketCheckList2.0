<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lista de Compras Compartilhada</title>
<style>
:root {
    --bg: #f4f4f4; --card: white; --text: #222; --accent: #28a745; --check-color: #ff5722;
}
.dark {
    --bg: #222; --card: #333; --text: #fff; --accent: #4caf50; --check-color: #ff9800;
}
body {
    font-family: Arial, sans-serif; background: var(--bg); color: var(--text);
    margin: 0; padding: 20px; transition: 0.3s;
}
#app {
    max-width: 900px; margin: auto; background: var(--card);
    padding: 20px; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.2);
}
h2 {text-align:center; margin-bottom:20px;}
input, select, button {padding:8px; margin:5px 0; border-radius:6px; border:1px solid #bbb; font-size:16px;}
button {background: var(--accent); color:white; border:none; cursor:pointer;}
button:hover {opacity:0.9;}
ul {list-style:none; padding:0; margin-top:10px;}
li {background:#ddd; color:#000; padding:10px; border-radius:6px; margin-bottom:10px; display:flex; flex-direction:column;}
.completed {background:#b7e4b1 !important; opacity: 0.8;}

/* FONTE DOS ITENS AJUSTADA */
.item-nome { font-size: 19px; font-weight: bold; color: #111; }

.linha {display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;}
.check-btn {background: var(--check-color); margin:5px 0; padding:10px 15px; border-radius:6px; color:#fff; font-weight:bold; border:none; cursor:pointer; font-size:16px;}
.delete-btn {background:red; margin:5px 0; padding:6px; border-radius:5px; color:#fff; border:none; cursor:pointer;}
.tab-buttons {display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;}
.tab-buttons button {flex:1;}
#totalChecked {text-align:right; font-weight:bold; margin-top:10px; font-size: 18px;}
#top-buttons {display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;}
#top-buttons button {flex:1;}
#inputs {display:flex; flex-wrap:wrap; gap:10px;}
#inputs input, #inputs select {flex:1 1 150px;}
#search-input {width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #bbb; font-size:16px;}
.category-section {margin-top:15px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 8px;}
.category-section h3 {margin-bottom:5px; border-bottom: 2px solid var(--accent); padding-bottom: 3px;}
.cat-item-row { display: flex; justify-content: space-between; margin: 3px 0; }
</style>
</head>
<body>

<div id="app">
    <h2>üõí Lista de Compras</h2>

    <div id="top-buttons">
        <button onclick="toggleDarkMode()">üåô Tema Escuro/Claro</button>
        <button onclick="limparLista()" style="background:#d9534f">üóë Limpar Lista</button>
        <button onclick="exportarLista()" style="background:#007bff">üì§ Exportar Lista</button>
        <button onclick="carregarSugestao()" style="background:#ffa500">üí° Sugest√µes</button>
    </div>

    <div class="tab-buttons">
        <button onclick="abrirAba('todos')">üìã Todos os Itens</button>
        <button onclick="abrirAba('checados')">‚úÖ Itens Pegos</button>
        <button onclick="abrirAba('categoria')">üìÇ Por Categoria</button>
    </div>

    <div id="aba-todos">
        <input type="text" id="search-input" placeholder="üîç Buscar item..." oninput="render()">
        <div id="inputs">
            <input type="text" id="nome" placeholder="Nome do produto">
            <input type="number" id="valor" placeholder="Valor" step="0.01">
            <input type="number" id="quantidade" placeholder="Qtd" value="1">
            <select id="categoria">
                <option>Hortifruti</option><option>Carnes</option><option>Latic√≠nios</option>
                <option>Mercearia</option><option>Higiene</option><option>Limpeza</option>
                <option>Bebidas</option><option>Outros</option>
            </select>
        </div>
        <button onclick="addItem()" style="width:100%; margin-top:10px;">‚ûï Adicionar Item</button>
        <ul id="lista"></ul>
    </div>

    <div id="aba-checados" style="display:none;">
        <ul id="lista-checados"></ul>
        <div id="totalChecked">Total Pegos: R$ 0,00</div>
    </div>

    <div id="aba-categoria" style="display:none;">
        <div id="categoria-lista"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, writeBatch, query, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCXslBuhgE9zd-ciH-3D4yIvdvAqYLGdHA",
        authDomain: "lista-de-mercado-7f370.firebaseapp.com",
        projectId: "lista-de-mercado-7f370",
        storageBucket: "lista-de-mercado-7f370.firebasestorage.app",
        messagingSenderId: "350679054404",
        appId: "1:350679054404:web:f88ae672c6b02a02fe2411"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const comprasRef = collection(db, "compras");

    enableIndexedDbPersistence(db).catch(() => {});

    let lista = [];

    window.toggleDarkMode = () => {
        const isDark = document.body.classList.toggle("dark");
        localStorage.setItem("darkMode", isDark);
    };
    if(localStorage.getItem("darkMode") === "true") document.body.classList.add("dark");

    const q = query(comprasRef, orderBy("criadoEm", "desc"));
    onSnapshot(q, (snapshot) => {
        lista = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
        renderChecados();
        renderCategoria();
    });

    window.addItem = async () => {
        const nome = document.getElementById("nome").value.trim();
        const valor = parseFloat(document.getElementById("valor").value) || 0;
        const quantidade = parseInt(document.getElementById("quantidade").value) || 1;
        const categoria = document.getElementById("categoria").value;
        if(!nome) return alert("Digite o nome!");

        await addDoc(comprasRef, { nome, valor, quantidade, categoria, checado: false, criadoEm: Date.now() });
        document.getElementById("nome").value = "";
        document.getElementById("valor").value = "";
    };

    window.checkItem = async (id, status) => {
        await updateDoc(doc(db, "compras", id), { checado: !status });
    };

    window.remover = async (id) => {
        if(confirm("Remover este item?")) await deleteDoc(doc(db, "compras", id));
    };

    window.atualizarValor = async (id, v) => {
        await updateDoc(doc(db, "compras", id), { valor: parseFloat(v) || 0 });
    };

    window.atualizarQuantidade = async (id, q) => {
        await updateDoc(doc(db, "compras", id), { quantidade: parseInt(q) || 1 });
    };

    window.limparLista = async () => {
        if(confirm("Apagar toda a lista?")){
            const batch = writeBatch(db);
            lista.forEach(item => batch.delete(doc(db, "compras", item.id)));
            await batch.commit();
        }
    };

    window.carregarSugestao = async () => {
        const sugestoes = [
            {nome:"Arroz", valor:25, quantidade:1, categoria:"Mercearia"},
            {nome:"Leite", valor:5, quantidade:4, categoria:"Latic√≠nios"}
        ];
        for(let s of sugestoes) await addDoc(comprasRef, { ...s, checado: false, criadoEm: Date.now() });
    };

    window.abrirAba = (aba) => {
        document.getElementById("aba-todos").style.display = aba==='todos' ? 'block' : 'none';
        document.getElementById("aba-checados").style.display = aba==='checados' ? 'block' : 'none';
        document.getElementById("aba-categoria").style.display = aba==='categoria' ? 'block' : 'none';
    };

    window.render = () => {
        const filtro = document.getElementById("search-input").value.toLowerCase();
        const ul = document.getElementById("lista");
        ul.innerHTML = "";
        lista.forEach((item) => {
            if(filtro && !item.nome.toLowerCase().includes(filtro)) return;
            let li = document.createElement("li");
            if(item.checado) li.classList.add("completed");
            li.innerHTML = `
                <div class="linha">
                    <strong class="item-nome">${item.nome}</strong>
                    <div style="display:flex; gap:5px;">
                        R$: <input type="number" value="${item.valor}" step="0.01" style="width:70px" onchange="atualizarValor('${item.id}', this.value)">
                        Qtd: <input type="number" value="${item.quantidade}" style="width:50px" onchange="atualizarQuantidade('${item.id}', this.value)">
                    </div>
                </div>
                <div class="linha" style="margin-top:8px;">
                    <small>Categoria: ${item.categoria}</small>
                    <div style="display:flex; gap:5px;">
                        <button class="check-btn" onclick="checkItem('${item.id}', ${item.checado})">${item.checado?'‚úÖ PEGOU':'‚òëÔ∏è CHECK'}</button>
                        <button class="delete-btn" onclick="remover('${item.id}')">Excluir</button>
                    </div>
                </div>
            `;
            ul.appendChild(li);
        });
    };

    window.renderChecados = () => {
        const ul = document.getElementById("lista-checados");
        ul.innerHTML = "";
        let total = 0;
        lista.filter(i => i.checado).forEach(i => {
            let sub = i.valor * i.quantidade;
            total += sub;
            ul.innerHTML += `<li><strong>${i.nome}</strong> (x${i.quantidade}) - R$ ${sub.toFixed(2)}</li>`;
        });
        document.getElementById("totalChecked").innerText = "Total Pegos: R$ " + total.toFixed(2);
    };

    window.renderCategoria = () => {
        const container = document.getElementById("categoria-lista");
        container.innerHTML = "";
        const categorias = [...new Set(lista.map(i => i.categoria))];
        categorias.forEach(cat => {
            const section = document.createElement("div");
            section.className = "category-section";
            let subtotal = 0;
            let itensHtml = "";
            
            lista.filter(i => i.categoria === cat).forEach(i => {
                let totalItem = i.valor * i.quantidade;
                subtotal += totalItem;
                itensHtml += `
                    <div class="cat-item-row">
                        <span>${i.checado ? '‚úÖ' : '‚¨ú'} ${i.nome} (x${i.quantidade})</span>
                        <span>R$ ${totalItem.toFixed(2)}</span>
                    </div>`;
            });

            section.innerHTML = `
                <h3>${cat}</h3>
                ${itensHtml}
                <div style="text-align:right; font-weight:bold; margin-top:5px; color: var(--accent);">Subtotal: R$ ${subtotal.toFixed(2)}</div>
            `;
            container.appendChild(section);
        });
    };

    window.exportarLista = () => {
        let texto = "üõí Lista de Compras:\n\n";
        lista.forEach(i => texto += `- ${i.nome} (x${i.quantidade}) ${i.checado?'[OK]':''}\n`);
        navigator.clipboard.writeText(texto).then(() => alert("Copiado!"));
    };
</script>
</body>
</html>
